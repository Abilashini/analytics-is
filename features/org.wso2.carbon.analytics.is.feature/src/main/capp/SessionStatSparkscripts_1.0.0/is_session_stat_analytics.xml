<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Analytics>
    <Name>is_session_stat_analytics</Name>
    <Script>
        CREATE TEMPORARY TABLE rawSessionData USING CarbonAnalytics OPTIONS (tableName "SESSION-ANALYTICS-STREAM",schema "sessionId STRING, action INT, userName STRING, tenantDomain STRING,_timestamp LONG" );

        CREATE TEMPORARY TABLE isRawSessionAnalytics USING CarbonAnalytics OPTIONS (tableName "SESSION-INFO-STREAM");

        CREATE TEMPORARY TABLE isSessionAnalyticsPerMinute USING CarbonAnalytics OPTIONS (tableName "IS-SESSION-STAT-PER-MINUTE");

        CREATE TEMPORARY TABLE isSessionAnalyticsPerHour USING CarbonAnalytics OPTIONS (tableName "Is-Session-Stat-per-Hour", schema "bucketId LONG -i, bucketStart LONG -i, bucketEnd LONG -i, activeSessionCount INT -i, newSessionCount INT -i, terminatedSessionCount INT -i", primaryKeys "bucketId, bucketStart, bucketEnd", incrementalParams "isSessionAnalyticsPerHour, 3600", mergeSchema "false");

        CREATE TEMPORARY TABLE isSessionAnalyticsPerDay USING CarbonAnalytics OPTIONS (tableName "Is-Session-Stat-per-Day", schema "bucketId LONG -i, bucketStart LONG -i, bucketEnd LONG -i, activeSessionCount INT -i, newSessionCount INT -i, terminatedSessionCount INT -i", primaryKeys "bucketId, bucketStart, bucketEnd", incrementalParams "isSessionAnalyticsPerDay, 3600", mergeSchema "false");

        CREATE TEMPORARY TABLE isSessionAnalyticsHourlyAggregate USING CarbonAnalytics OPTIONS (tableName "Is-Session-Stat-Aggregate-per-Hour", schema "bucketStart LONG -i, bucketEnd LONG -i, userName FACET -i, longestSession LONG -i, averageSession LONG -i", primaryKeys "bucketStart, bucketEnd, userName", incrementalParams "isSessionAnalyticsTimelyAggregate, 3600", mergeSchema "false");

        CREATE TEMPORARY TABLE isSessionAnalyticsDailyAggregate USING CarbonAnalytics OPTIONS (tableName "Is-Session-Stat-Aggregate-per-Day", schema "bucketStart LONG -i, bucketEnd LONG -i, userName FACET -i, longestSession LONG -i, averageSession LONG -i", primaryKeys "bucketStart, bucketEnd, userName", incrementalParams "isSessionAnalyticsTimelyAggregate, 3600", mergeSchema "false");

        INSERT INTO TABLE isSessionAnalyticsPerHour SELECT (bucketStart - bucketStart%3600000) as bucketId, (bucketStart - bucketStart%3600000) as bucketStart, ((bucketStart - bucketStart%3600000) + 3600000)  as bucketEnd, last(activeSessionCount) as activeSessionCount, sum(newSessionCount) as newSessionCount, sum(terminatedSessionCount) as terminatedSessionCount from (select * from isSessionAnalyticsPerMinute order by bucketStart) temp group by (bucketStart - bucketStart%3600000) order by bucketStart;

        INSERT INTO TABLE isSessionAnalyticsPerDay SELECT (bucketStart - bucketStart%86400000) as bucketId, (bucketStart - bucketStart%86400000) as bucketStart, ((bucketStart - bucketStart%86400000) + 86400000)  as bucketEnd, last(activeSessionCount) as activeSessionCount, sum(newSessionCount) as newSessionCount, sum(terminatedSessionCount) as terminatedSessionCount from (select * from isSessionAnalyticsPerHour order by bucketStart) temp group by (bucketStart - bucketStart%86400000) order by bucketStart;

        INSERT INTO TABLE isSessionAnalyticsHourlyAggregate SELECT (startTimestamp - startTimestamp%3600000) as bucketStart, ((startTimestamp - startTimestamp%3600000) + 3600000)  as bucketEnd, userName, max(duration) as longestSession, avg(duration) as averageSession from (select * from isRawSessionAnalytics order by startTimestamp) temp group by (startTimestamp - startTimestamp%3600000), userName order by bucketStart;

        INSERT INTO TABLE isSessionAnalyticsDailyAggregate SELECT (bucketStart - bucketStart%86400000) as bucketStart, ((bucketStart - bucketStart%86400000) + 86400000)  as bucketEnd, userName, max(longestSession) as longestSession, avg(averageSession) as averageSession from (select * from isSessionAnalyticsHourlyAggregate order by bucketStart) temp group by (bucketStart - bucketStart%86400000), userName order by bucketStart;
    </Script>
    <CronExpression>0 0/5 * * * ?</CronExpression>
</Analytics>
